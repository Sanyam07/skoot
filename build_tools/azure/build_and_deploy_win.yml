steps:
  - powershell: |
      $wc = New-Object net.webclient;
      $wc.Downloadfile("$(openblas)", "openblas.zip")
      $tmpdir = New-TemporaryFile | %{ rm $_; mkdir $_ }
      Expand-Archive "openblas.zip" $tmpdir
      $pyversion = python -c "from __future__ import print_function; import sys; print(sys.version.split()[0])"
      Write-Host "Python Version: $pyversion"
      $target = "C:\\hostedtoolcache\\windows\\Python\\$pyversion\\$(architecture)\\lib\\openblas.a"
      Write-Host "target path: $target"
      cp $tmpdir\$(bits)\lib\libopenblas_v0.3.5-274-g6a8b4269-gcc_7_1_0.a $target
      displayName: 'Download / Install OpenBLAS'

  - powershell: |
      # wheels appear to use mingw64 version 6.3.0, but 6.4.0
      # is the closest match available from choco package manager
      choco install -y mingw --forcex86 --force --version=6.4.0
    displayName: 'Install 32-bit mingw for 32-bit builds'
    condition: eq(variables['bits'], 32)

  - powershell: |
      choco install -y mingw --force --version=6.4.0
    displayName: 'Install 64-bit mingw for 64-bit builds'
    condition: eq(variables['bits'], 64)

  - script: python -m pip install numpy cython==0.29.2 pybind11 pytest pytest-timeout pytest-xdist pytest-env pytest-cov Pillow mpmath
    displayName: 'Install dependencies'
  - powershell: |
      If ($(bits) -eq 32) {
          # 32-bit build requires careful adjustments
          # until Microsoft has a switch we can use
          # directly for i686 mingw
          $env:NPY_DISTUTILS_APPEND_FLAGS = 1
          $env:CFLAGS = "-m32"
          $env:LDFLAGS = "-m32"
          refreshenv
      }
      $env:PATH = "C:\\ProgramData\\chocolatey\\lib\\mingw\\tools\\install\\mingw$(bits)\\bin;" + $env:PATH
      mkdir dist
      pip wheel --no-build-isolation -v -v -v --wheel-dir=dist .
      ls dist -r | Foreach-Object {
          pip install $_.FullName
      }
    displayName: 'Build Skoot'
  - powershell: |
      $env:PATH = "C:\\ProgramData\\chocolatey\\lib\\mingw\\tools\\install\\mingw$(bits)\\bin;" + $env:PATH
      python -m pytest skoot
    displayName: 'Run Skoot Test Suite'
